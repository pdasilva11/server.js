name: Vault Secret to Mounted File in Pod

on:
  workflow_dispatch:

jobs:
  retrieve-and-deploy:
    runs-on: self-hosted

    env:
      API_URL: ${{ vars.API_URL }}
      VERIFY_CA: ${{ vars.VERIFY_CA }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      CERTIFICATE: ${{ secrets.CERTIFICATE }}
      CERTIFICATE_KEY: ${{ secrets.CERTIFICATE_KEY }}
      SECRET_PATH: '{"path": "nav/docker", "output_id": "docker"}'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract DEPLOY_KEY from SECRET_PATH
        id: extract_key
        run: |
          echo "Extracting DEPLOY_KEY from SECRET_PATH..."
          DEPLOY_KEY=$(echo "$SECRET_PATH" | jq -r .output_id)
          echo "DEPLOY_KEY=$DEPLOY_KEY" >> $GITHUB_ENV
          echo "DEPLOY_KEY=$DEPLOY_KEY" > /opt/tmp/secret.txt

      - name: Debug Secret Content
        run: |
          echo "Secret content:"
          cat /opt/tmp/secret.txt

      - name: Check current user and validate kubeconfig
        run: |
          whoami
          ls -l $HOME/.kube/config

      - name: Set KUBECONFIG and Verify Kubernetes Config
        run: |
          export KUBECONFIG=$HOME/.kube/config
          kubectl config view

      - name: Create Kubernetes secret from retrieved file
        run: |
          export KUBECONFIG=$HOME/.kube/config
          kubectl delete secret vault-secret --ignore-not-found
          kubectl create secret generic vault-secret --from-file=secret.txt=/opt/tmp/secret.txt

      - name: Create Pod YAML with BeyondTrust container and mounted secret
        run: |
          cat <<EOF > /opt/tmp/vault-test-pod.yaml
          apiVersion: v1
          kind: Pod
          metadata:
            name: jumpoint-pod
            namespace: default
          spec:
            containers:
            - name: jumpoint-name
              image: beyondtrust/sra-jumpoint:1cd9128ba1
              env:
              - name: DEPLOY_KEY
                valueFrom:
                  secretKeyRef:
                    name: vault-secret
                    key: secret.txt
              volumeMounts:
              - name: jpt-vol
                mountPath: /jpt
              securityContext:
                capabilities:
                  add: ["IPC_LOCK"]
            volumes:
            - name: jpt-vol
              hostPath:
                path: /data
                type: Directory
          EOF

      - name: Confirm YAML file exists
        run: |
          cat /opt/tmp/vault-test-pod.yaml

      - name: Deploy Pod using kubectl
        run: |
          export KUBECONFIG=$HOME/.kube/config
          kubectl apply -f /opt/tmp/vault-test-pod.yaml
